// ==UserScript==
// @name        notion-kroki
// @namespace   https://github.com/zuisong/notion-kroki
// @grant       none
// @version     1.1.2
// @match        *://www.notion.so/*
// @match        *://*.notion.site/*
// @match        *://*.super.site/*
// @supportURL  https://github.com/zuisong/notion-kroki/issues
// @run-at      document-idle
// @author      zuisong
// @description Render notion code block as graph by kroki
// ==/UserScript==

(()=>{"use strict";var r=Uint8Array,n=Uint16Array,e=Uint32Array,t=new r([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),o=new r([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),a=new r([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),i=function(r,t){for(var o=new n(31),a=0;a<31;++a)o[a]=t+=1<<r[a-1];var i=new e(o[30]);for(a=1;a<30;++a)for(var f=o[a];f<o[a+1];++f)i[f]=f-o[a]<<5|a;return[o,i]},f=i(t,2),l=f[0],u=f[1];l[28]=258,u[258]=28;for(var c=i(o,0),v=(c[0],c[1]),s=new n(32768),d=0;d<32768;++d){var h=(43690&d)>>>1|(21845&d)<<1;h=(61680&(h=(52428&h)>>>2|(13107&h)<<2))>>>4|(3855&h)<<4,s[d]=((65280&h)>>>8|(255&h)<<8)>>>1}var m=function(r,e,t){for(var o=r.length,a=0,i=new n(e);a<o;++a)r[a]&&++i[r[a]-1];var f,l=new n(e);for(a=0;a<e;++a)l[a]=l[a-1]+i[a-1]<<1;if(t){f=new n(1<<e);var u=15-e;for(a=0;a<o;++a)if(r[a])for(var c=a<<4|r[a],v=e-r[a],d=l[r[a]-1]++<<v,h=d|(1<<v)-1;d<=h;++d)f[s[d]>>>u]=c}else for(f=new n(o),a=0;a<o;++a)r[a]&&(f[a]=s[l[r[a]-1]++]>>>15-r[a]);return f},g=new r(288);for(d=0;d<144;++d)g[d]=8;for(d=144;d<256;++d)g[d]=9;for(d=256;d<280;++d)g[d]=7;for(d=280;d<288;++d)g[d]=8;var w=new r(32);for(d=0;d<32;++d)w[d]=5;var p=m(g,9,0),y=m(w,5,0),E=function(r){return(r+7)/8|0},k=function(t,o,a){(null==o||o<0)&&(o=0),(null==a||a>t.length)&&(a=t.length);var i=new(2==t.BYTES_PER_ELEMENT?n:4==t.BYTES_PER_ELEMENT?e:r)(a-o);return i.set(t.subarray(o,a)),i},T=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],b=function(r,n,e){var t=new Error(n||T[r]);if(t.code=r,Error.captureStackTrace&&Error.captureStackTrace(t,b),!e)throw t;return t},M=function(r,n,e){e<<=7&n;var t=n/8|0;r[t]|=e,r[t+1]|=e>>>8},x=function(r,n,e){e<<=7&n;var t=n/8|0;r[t]|=e,r[t+1]|=e>>>8,r[t+2]|=e>>>16},C=function(e,t){for(var o=[],a=0;a<e.length;++a)e[a]&&o.push({s:a,f:e[a]});var i=o.length,f=o.slice();if(!i)return[L,0];if(1==i){var l=new r(o[0].s+1);return l[o[0].s]=1,[l,1]}o.sort((function(r,n){return r.f-n.f})),o.push({s:-1,f:25001});var u=o[0],c=o[1],v=0,s=1,d=2;for(o[0]={s:-1,f:u.f+c.f,l:u,r:c};s!=i-1;)u=o[o[v].f<o[d].f?v++:d++],c=o[v!=s&&o[v].f<o[d].f?v++:d++],o[s++]={s:-1,f:u.f+c.f,l:u,r:c};var h=f[0].s;for(a=1;a<i;++a)f[a].s>h&&(h=f[a].s);var m=new n(h+1),g=S(o[s-1],m,0);if(g>t){a=0;var w=0,p=g-t,y=1<<p;for(f.sort((function(r,n){return m[n.s]-m[r.s]||r.f-n.f}));a<i;++a){var E=f[a].s;if(!(m[E]>t))break;w+=y-(1<<g-m[E]),m[E]=t}for(w>>>=p;w>0;){var k=f[a].s;m[k]<t?w-=1<<t-m[k]++-1:++a}for(;a>=0&&w;--a){var T=f[a].s;m[T]==t&&(--m[T],++w)}g=t}return[new r(m),g]},S=function(r,n,e){return-1==r.s?Math.max(S(r.l,n,e+1),S(r.r,n,e+1)):n[r.s]=e},P=function(r){for(var e=r.length;e&&!r[--e];);for(var t=new n(++e),o=0,a=r[0],i=1,f=function(r){t[o++]=r},l=1;l<=e;++l)if(r[l]==a&&l!=e)++i;else{if(!a&&i>2){for(;i>138;i-=138)f(32754);i>2&&(f(i>10?i-11<<5|28690:i-3<<5|12305),i=0)}else if(i>3){for(f(a),--i;i>6;i-=6)f(8304);i>2&&(f(i-3<<5|8208),i=0)}for(;i--;)f(a);i=1,a=r[l]}return[t.subarray(0,o),e]},A=function(r,n){for(var e=0,t=0;t<n.length;++t)e+=r[t]*n[t];return e},U=function(r,n,e){var t=e.length,o=E(n+2);r[o]=255&t,r[o+1]=t>>>8,r[o+2]=255^r[o],r[o+3]=255^r[o+1];for(var a=0;a<t;++a)r[o+a+4]=e[a];return 8*(o+4+t)},$=function(r,e,i,f,l,u,c,v,s,d,h){M(e,h++,i),++l[256];for(var E=C(l,15),k=E[0],T=E[1],b=C(u,15),S=b[0],$=b[1],_=P(k),L=_[0],N=_[1],Y=P(S),q=Y[0],R=Y[1],j=new n(19),B=0;B<L.length;++B)j[31&L[B]]++;for(B=0;B<q.length;++B)j[31&q[B]]++;for(var D=C(j,7),F=D[0],O=D[1],z=19;z>4&&!F[a[z-1]];--z);var H,I,W,X,G=d+5<<3,J=A(l,g)+A(u,w)+c,K=A(l,k)+A(u,S)+c+14+3*z+A(j,F)+(2*j[16]+3*j[17]+7*j[18]);if(G<=J&&G<=K)return U(e,h,r.subarray(s,s+d));if(M(e,h,1+(K<J)),h+=2,K<J){H=m(k,T,0),I=k,W=m(S,$,0),X=S;var Q=m(F,O,0);for(M(e,h,N-257),M(e,h+5,R-1),M(e,h+10,z-4),h+=14,B=0;B<z;++B)M(e,h+3*B,F[a[B]]);h+=3*z;for(var V=[L,q],Z=0;Z<2;++Z){var rr=V[Z];for(B=0;B<rr.length;++B){var nr=31&rr[B];M(e,h,Q[nr]),h+=F[nr],nr>15&&(M(e,h,rr[B]>>>5&127),h+=rr[B]>>>12)}}}else H=p,I=g,W=y,X=w;for(B=0;B<v;++B)if(f[B]>255){nr=f[B]>>>18&31,x(e,h,H[nr+257]),h+=I[nr+257],nr>7&&(M(e,h,f[B]>>>23&31),h+=t[nr]);var er=31&f[B];x(e,h,W[er]),h+=X[er],er>3&&(x(e,h,f[B]>>>5&8191),h+=o[er])}else x(e,h,H[f[B]]),h+=I[f[B]];return x(e,h,H[256]),h+I[256]},_=new e([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),L=new r(0),N=function(a,i,f,l,c){return function(a,i,f,l,c,s){var d=a.length,h=new r(l+d+5*(1+Math.ceil(d/7e3))+c),m=h.subarray(l,h.length-c),g=0;if(!i||d<8)for(var w=0;w<=d;w+=65535){var p=w+65535;p>=d&&(m[g>>3]=s),g=U(m,g+1,a.subarray(w,p))}else{for(var y=_[i-1],T=y>>>13,b=8191&y,M=(1<<f)-1,x=new n(32768),C=new n(M+1),S=Math.ceil(f/3),P=2*S,A=function(r){return(a[r]^a[r+1]<<S^a[r+2]<<P)&M},N=new e(25e3),Y=new n(288),q=new n(32),R=0,j=0,B=(w=0,0),D=0,F=0;w<d;++w){var O=A(w),z=32767&w,H=C[O];if(x[z]=H,C[O]=z,D<=w){var I=d-w;if((R>7e3||B>24576)&&I>423){g=$(a,m,0,N,Y,q,j,B,F,w-F,g),B=R=j=0,F=w;for(var W=0;W<286;++W)Y[W]=0;for(W=0;W<30;++W)q[W]=0}var X=2,G=0,J=b,K=z-H&32767;if(I>2&&O==A(w-K))for(var Q=Math.min(T,I)-1,V=Math.min(32767,w),Z=Math.min(258,I);K<=V&&--J&&z!=H;){if(a[w+X]==a[w+X-K]){for(var rr=0;rr<Z&&a[w+rr]==a[w+rr-K];++rr);if(rr>X){if(X=rr,G=K,rr>Q)break;var nr=Math.min(K,rr-2),er=0;for(W=0;W<nr;++W){var tr=w-K+W+32768&32767,or=tr-x[tr]+32768&32767;or>er&&(er=or,H=tr)}}}K+=(z=H)-(H=x[z])+32768&32767}if(G){N[B++]=268435456|u[X]<<18|v[G];var ar=31&u[X],ir=31&v[G];j+=t[ar]+o[ir],++Y[257+ar],++q[ir],D=w+X,++R}else N[B++]=a[w],++Y[a[w]]}}g=$(a,m,s,N,Y,q,j,B,F,w-F,g),!s&&7&g&&(g=U(m,g+1,L))}return k(h,0,l+E(g)+c)}(a,null==i.level?6:i.level,null==i.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(a.length)))):12+i.mem,f,l,!c)};function Y(r,n){n||(n={});var e=function(){var r=1,n=0;return{p:function(e){for(var t=r,o=n,a=0|e.length,i=0;i!=a;){for(var f=Math.min(i+2655,a);i<f;++i)o+=t+=e[i];t=(65535&t)+15*(t>>16),o=(65535&o)+15*(o>>16)}r=t,n=o},d:function(){return(255&(r%=65521))<<24|r>>>8<<16|(255&(n%=65521))<<8|n>>>8}}}();e.p(r);var t=N(r,n,2,4);return function(r,n){var e=n.level,t=0==e?0:e<6?1:9==e?3:2;r[0]=120,r[1]=t<<6|(t?32-2*t:1)}(t,n),function(r,n,e){for(;e;++n)r[n]=e,e>>>=8}(t,t.length-4,e.d()),t}var q="undefined"!=typeof TextDecoder&&new TextDecoder;try{q.decode(L,{stream:!0})}catch(r){}function R(r,n){if(n){for(var e="",t=0;t<r.length;t+=16384)e+=String.fromCharCode.apply(null,r.subarray(t,t+16384));return e}if(q)return q.decode(r);var o=function(r){for(var n="",e=0;;){var t=r[e++],o=(t>127)+(t>223)+(t>239);if(e+o>r.length)return[n,k(r,e-1)];o?3==o?(t=((15&t)<<18|(63&r[e++])<<12|(63&r[e++])<<6|63&r[e++])-65536,n+=String.fromCharCode(55296|t>>10,56320|1023&t)):n+=1&o?String.fromCharCode((31&t)<<6|63&r[e++]):String.fromCharCode((15&t)<<12|(63&r[e++])<<6|63&r[e++]):n+=String.fromCharCode(t)}}(r),a=o[0];return o[1].length&&b(8),a}"function"==typeof queueMicrotask?queueMicrotask:"function"==typeof setTimeout&&setTimeout;function j(r){localStorage.getItem("debug")&&console.log(r)}const B={serverPath:"//kroki.io/"};async function D(r=null){await async function(r){return new Promise(((r,n)=>setTimeout(r,3e3)))}();const n=function(r,n){const e=document.evaluate("//*[starts-with(text(),'//kroki ')]",n,null,XPathResult.ANY_TYPE,null),t=[];let o;for(;o=e.iterateNext(),o;)t.push(o);return t}(0,r??document.body);for(const r of n)if(r&&r.innerText.startsWith("//kroki")){var e,t,o,a;const n=r.innerText.split("\n"),u=n[0].replace("//kroki","").trim();if(null==u||!u.trim())continue;const c=n.filter(((r,n)=>0!=n)).join("\n");if(null==c||!c.trim())continue;const v=F(c,u,B),s=document.createElement("div",void 0);s.style.cssText="display: flex; flex-direction: row; place-content: center;",s.setAttribute("notion-kroki","true"),s.innerHTML=`<object type="image/svg+xml" style="max-width: 100%;" data="${v}" />`;const d=null===(e=r.parentElement)||void 0===e||null===(t=e.parentElement)||void 0===t?void 0:t.querySelector("div[notion-kroki]");if(d){var i;const n=null===(i=d.firstElementChild)||void 0===i?void 0:i.getAttribute("data");if(j(`preSvgUrl:${n}`),j(`svgUrl:${v}`),n==v)continue;var f,l;null===(f=r.parentElement)||void 0===f||null===(l=f.parentElement)||void 0===l||l.removeChild(d)}null===(o=r.parentElement)||void 0===o||null===(a=o.parentElement)||void 0===a||a.appendChild(s)}}function F(r,n,e){r=r.trim(),j(`kroki render type: ${n}`),j(`kroki render content: \n ${r}`);const t=`${(null==e?void 0:e.serverPath)+n}/svg/`;var o;const a=R(Y((o=r,(new TextEncoder).encode(o)),{level:9}),!0);return t+window.btoa(a).replace(/\+/g,"-").replace(/\//g,"_")}D(),new MutationObserver((function(r,n){j(r),r.forEach((r=>{var n,e,t,o,a,i,f;(n=D,e=1e3,t=!0,o=null,a=null,i=function(){o&&(clearTimeout(o),a=null,o=null)},f=function(){if(!e)return n.apply(this,arguments);var r=this,f=arguments,l=t&&!o;return i(),a=function(){n.apply(r,f)},o=setTimeout((function(){if(o=null,!l){var r=a;return a=null,r()}}),e),l?a():void 0},f.cancel=i,f.flush=function(){var r=a;i(),r&&r()},f)(r.target)}))})).observe(document,{childList:!0,subtree:!0})})();
