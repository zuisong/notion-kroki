// ==UserScript==
// @name        notion-kroki
// @namespace   https://github.com/zuisong/notion-kroki
// @grant       none
// @version     1.1.4
// @match        *://www.notion.so/*
// @match        *://*.notion.site/*
// @match        *://*.super.site/*
// @supportURL  https://github.com/zuisong/notion-kroki/issues
// @run-at      document-idle
// @author      zuisong
// @description Render notion code block as graph by kroki
// ==/UserScript==

async function pr(r){return new Promise((n,e)=>setTimeout(n,r))}function gr(r,n){let e=document.evaluate(r,n,null,XPathResult.ANY_TYPE,null),t=[],i;for(;i=e.iterateNext(),i;)t.push(i);return t}function j(r){localStorage.getItem("debug")&&console.log(r)}function yr(r,n){let e;return function(...t){clearTimeout(e),e=setTimeout(()=>r(t),n)}}var Z=Uint8Array,z=Uint16Array,b=Uint32Array,fr=new Z([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),sr=new Z([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),mr=new Z([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Tr=function(r,n){for(var e=new z(31),t=0;t<31;++t)e[t]=n+=1<<r[t-1];for(var i=new b(e[30]),t=1;t<30;++t)for(var o=e[t];o<e[t+1];++o)i[o]=o-e[t]<<5|t;return[e,i]},Ar=Tr(fr,2),Dr=Ar[0],er=Ar[1];Dr[28]=258,er[258]=28;var Er=Tr(sr,0),Xr=Er[0],wr=Er[1],ir=new z(32768);for(u=0;u<32768;++u)O=(u&43690)>>>1|(u&21845)<<1,O=(O&52428)>>>2|(O&13107)<<2,O=(O&61680)>>>4|(O&3855)<<4,ir[u]=((O&65280)>>>8|(O&255)<<8)>>>1;var O,u,J=function(r,n,e){for(var t=r.length,i=0,o=new z(n);i<t;++i)r[i]&&++o[r[i]-1];var f=new z(n);for(i=0;i<n;++i)f[i]=f[i-1]+o[i-1]<<1;var l;if(e){l=new z(1<<n);var h=15-n;for(i=0;i<t;++i)if(r[i])for(var v=i<<4|r[i],a=n-r[i],c=f[r[i]-1]++<<a,g=c|(1<<a)-1;c<=g;++c)l[ir[c]>>>h]=v}else for(l=new z(t),i=0;i<t;++i)r[i]&&(l[i]=ir[f[r[i]-1]++]>>>15-r[i]);return l},H=new Z(288);for(u=0;u<144;++u)H[u]=8;var u;for(u=144;u<256;++u)H[u]=9;var u;for(u=256;u<280;++u)H[u]=7;var u;for(u=280;u<288;++u)H[u]=8;var u,V=new Z(32);for(u=0;u<32;++u)V[u]=5;var u,dr=J(H,9,0);var Fr=J(V,5,0);var Mr=function(r){return(r+7)/8|0},Ir=function(r,n,e){(n==null||n<0)&&(n=0),(e==null||e>r.length)&&(e=r.length);var t=new(r.BYTES_PER_ELEMENT==2?z:r.BYTES_PER_ELEMENT==4?b:Z)(e-n);return t.set(r.subarray(n,e)),t};var G=function(r,n,e){e<<=n&7;var t=n/8|0;r[t]|=e,r[t+1]|=e>>>8},W=function(r,n,e){e<<=n&7;var t=n/8|0;r[t]|=e,r[t+1]|=e>>>8,r[t+2]|=e>>>16},tr=function(r,n){for(var e=[],t=0;t<r.length;++t)r[t]&&e.push({s:t,f:r[t]});var i=e.length,o=e.slice();if(!i)return[ur,0];if(i==1){var f=new Z(e[0].s+1);return f[e[0].s]=1,[f,1]}e.sort(function(d,M){return d.f-M.f}),e.push({s:-1,f:25001});var l=e[0],h=e[1],v=0,a=1,c=2;for(e[0]={s:-1,f:l.f+h.f,l,r:h};a!=i-1;)l=e[e[v].f<e[c].f?v++:c++],h=e[v!=a&&e[v].f<e[c].f?v++:c++],e[a++]={s:-1,f:l.f+h.f,l,r:h};for(var g=o[0].s,t=1;t<i;++t)o[t].s>g&&(g=o[t].s);var p=new z(g+1),w=ar(e[a-1],p,0);if(w>n){var t=0,y=0,E=w-n,P=1<<E;for(o.sort(function(M,x){return p[x.s]-p[M.s]||M.f-x.f});t<i;++t){var D=o[t].s;if(p[D]>n)y+=P-(1<<w-p[D]),p[D]=n;else break}for(y>>>=E;y>0;){var R=o[t].s;p[R]<n?y-=1<<n-p[R]++-1:++t}for(;t>=0&&y;--t){var L=o[t].s;p[L]==n&&(--p[L],++y)}w=n}return[new Z(p),w]},ar=function(r,n,e){return r.s==-1?Math.max(ar(r.l,n,e+1),ar(r.r,n,e+1)):n[r.s]=e},xr=function(r){for(var n=r.length;n&&!r[--n];);for(var e=new z(++n),t=0,i=r[0],o=1,f=function(h){e[t++]=h},l=1;l<=n;++l)if(r[l]==i&&l!=n)++o;else{if(!i&&o>2){for(;o>138;o-=138)f(32754);o>2&&(f(o>10?o-11<<5|28690:o-3<<5|12305),o=0)}else if(o>3){for(f(i),--o;o>6;o-=6)f(8304);o>2&&(f(o-3<<5|8208),o=0)}for(;o--;)f(i);o=1,i=r[l]}return[e.subarray(0,t),n]},X=function(r,n){for(var e=0,t=0;t<n.length;++t)e+=r[t]*n[t];return e},or=function(r,n,e){var t=e.length,i=Mr(n+2);r[i]=t&255,r[i+1]=t>>>8,r[i+2]=r[i]^255,r[i+3]=r[i+1]^255;for(var o=0;o<t;++o)r[i+o+4]=e[o];return(i+4+t)*8},zr=function(r,n,e,t,i,o,f,l,h,v,a){G(n,a++,e),++i[256];for(var c=tr(i,15),g=c[0],p=c[1],w=tr(o,15),y=w[0],E=w[1],P=xr(g),D=P[0],R=P[1],L=xr(y),d=L[0],M=L[1],x=new z(19),s=0;s<D.length;++s)x[D[s]&31]++;for(var s=0;s<d.length;++s)x[d[s]&31]++;for(var $=tr(x,7),U=$[0],Q=$[1],T=19;T>4&&!U[mr[T-1]];--T);var Y=v+5<<3,k=X(i,H)+X(o,V)+f,S=X(i,g)+X(o,y)+f+14+3*T+X(x,U)+(2*x[16]+3*x[17]+7*x[18]);if(Y<=k&&Y<=S)return or(n,a,r.subarray(h,h+v));var F,m,C,N;if(G(n,a,1+(S<k)),a+=2,S<k){F=J(g,p,0),m=g,C=J(y,E,0),N=y;var _=J(U,Q,0);G(n,a,R-257),G(n,a+5,M-1),G(n,a+10,T-4),a+=14;for(var s=0;s<T;++s)G(n,a+3*s,U[mr[s]]);a+=3*T;for(var I=[D,d],K=0;K<2;++K)for(var q=I[K],s=0;s<q.length;++s){var B=q[s]&31;G(n,a,_[B]),a+=U[B],B>15&&(G(n,a,q[s]>>>5&127),a+=q[s]>>>12)}}else F=dr,m=H,C=Fr,N=V;for(var s=0;s<l;++s)if(t[s]>255){var B=t[s]>>>18&31;W(n,a,F[B+257]),a+=m[B+257],B>7&&(G(n,a,t[s]>>>23&31),a+=fr[B]);var A=t[s]&31;W(n,a,C[A]),a+=N[A],A>3&&(W(n,a,t[s]>>>5&8191),a+=sr[A])}else W(n,a,F[t[s]]),a+=m[t[s]];return W(n,a,F[256]),a+m[256]},Br=new b([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),ur=new Z(0),Zr=function(r,n,e,t,i,o){var f=r.length,l=new Z(t+f+5*(1+Math.ceil(f/7e3))+i),h=l.subarray(t,l.length-i),v=0;if(!n||f<8)for(var a=0;a<=f;a+=65535){var c=a+65535;c>=f&&(h[v>>3]=o),v=or(h,v+1,r.subarray(a,c))}else{for(var g=Br[n-1],p=g>>>13,w=g&8191,y=(1<<e)-1,E=new z(32768),P=new z(y+1),D=Math.ceil(e/3),R=2*D,L=function(nr){return(r[nr]^r[nr+1]<<D^r[nr+2]<<R)&y},d=new b(25e3),M=new z(288),x=new z(32),s=0,$=0,a=0,U=0,Q=0,T=0;a<f;++a){var Y=L(a),k=a&32767,S=P[Y];if(E[k]=S,P[Y]=k,Q<=a){var F=f-a;if((s>7e3||U>24576)&&F>423){v=zr(r,h,0,d,M,x,$,U,T,a-T,v),U=s=$=0,T=a;for(var m=0;m<286;++m)M[m]=0;for(var m=0;m<30;++m)x[m]=0}var C=2,N=0,_=w,I=k-S&32767;if(F>2&&Y==L(a-I))for(var K=Math.min(p,F)-1,q=Math.min(32767,a),B=Math.min(258,F);I<=q&&--_&&k!=S;){if(r[a+C]==r[a+C-I]){for(var A=0;A<B&&r[a+A]==r[a+A-I];++A);if(A>C){if(C=A,N=I,A>K)break;for(var Sr=Math.min(I,A-2),lr=0,m=0;m<Sr;++m){var rr=a-I+m+32768&32767,Cr=E[rr],vr=rr-Cr+32768&32767;vr>lr&&(lr=vr,S=rr)}}}k=S,S=E[k],I+=k-S+32768&32767}if(N){d[U++]=268435456|er[C]<<18|wr[N];var hr=er[C]&31,cr=wr[N]&31;$+=fr[hr]+sr[cr],++M[257+hr],++x[cr],Q=a+C,++s}else d[U++]=r[a],++M[r[a]]}}v=zr(r,h,o,d,M,x,$,U,T,a-T,v),!o&&v&7&&(v=or(h,v+1,ur))}return Ir(l,0,t+Mr(v)+i)};var Pr=function(){var r=1,n=0;return{p:function(e){for(var t=r,i=n,o=e.length|0,f=0;f!=o;){for(var l=Math.min(f+2655,o);f<l;++f)i+=t+=e[f];t=(t&65535)+15*(t>>16),i=(i&65535)+15*(i>>16)}r=t,n=i},d:function(){return r%=65521,n%=65521,(r&255)<<24|r>>>8<<16|(n&255)<<8|n>>>8}}},Or=function(r,n,e,t,i){return Zr(r,n.level==null?6:n.level,n.mem==null?Math.ceil(Math.max(8,Math.min(13,Math.log(r.length)))*1.5):12+n.mem,e,t,!i)};var Gr=function(r,n,e){for(;e;++n)r[n]=e,e>>>=8};var Lr=function(r,n){var e=n.level,t=e==0?0:e<6?1:e==9?3:2;r[0]=120,r[1]=t<<6|(t?32-2*t:1)};function Ur(r,n){n||(n={});var e=Pr();e.p(r);var t=Or(r,n,2,4);return Lr(t,n),Gr(t,t.length-4,e.d()),t}var Nr=typeof TextDecoder<"u"&&new TextDecoder,$r=0;try{Nr.decode(ur,{stream:!0}),$r=1}catch(r){}var Hr={serverPath:"//kroki.io/"};function Rr(r){return btoa(r)}async function kr(r=null){var e,t,i,o,f,l,h;await pr(3e3);let n=gr("//*[starts-with(text(),'//kroki ')]",r!=null?r:document.body);for(let v of n)if(!!v&&v.innerText.startsWith("//kroki")){let a=v.innerText.split(`
`),c=a[0].replace("//kroki","").trim();if(!(c!=null&&c.trim()))continue;let g=a.filter((E,P)=>P!=0).join(`
`);if(!(g!=null&&g.trim()))continue;let p=qr(g,c,Hr),w=document.createElement("div",void 0);w.style.cssText="display: flex; flex-direction: row; place-content: center;",w.setAttribute("notion-kroki","true"),w.innerHTML=`<object type="image/svg+xml" style="max-width: 100%;" data="${p}" />`;let y=(t=(e=v.parentElement)==null?void 0:e.parentElement)==null?void 0:t.querySelector("div[notion-kroki]");if(y){let E=(i=y.firstElementChild)==null?void 0:i.getAttribute("data");if(j(`preSvgUrl:${E}`),j(`svgUrl:${p}`),E==p)continue;(f=(o=v.parentElement)==null?void 0:o.parentElement)==null||f.removeChild(y)}(h=(l=v.parentElement)==null?void 0:l.parentElement)==null||h.appendChild(w)}}function Yr(r){return new TextEncoder().encode(r)}function qr(r,n,e){r=r.trim(),j(`kroki render type: ${n}`),j(`kroki render content: 
 ${r}`);let t=`${(e==null?void 0:e.serverPath)+n}/svg/`,i=Yr(r),o=Kr(Ur(i,{level:9})),f=Rr(o).replace(/\+/g,"-").replace(/\//g,"_");return t+f}kr();new MutationObserver(jr).observe(document,{childList:!0,subtree:!0});function jr(r,n){j(r),r.forEach(e=>{yr(()=>kr(),1e3)(e.target)})}function Kr(r){let n="";for(let e=0;e<r.length;e+=16384)n+=String.fromCharCode(...r.subarray(e,e+16384));return n}

