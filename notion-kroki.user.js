// ==UserScript==
// @name        notion-kroki
// @namespace   https://github.com/zuisong/notion-kroki
// @grant       none
// @version     1.0.0
// @inject-into content
// @match        *://www.notion.so/*
// @supportURL  https://github.com/zuisong/notion-kroki/issues
// @run-at      document-idle
// @author      zuisong
// @description Render notion code block as graph by kroki
// ==/UserScript==

(()=>{"use strict";var r,e,n,t,o={166:(r,e,n)=>{async function t(r){return new Promise(((e,n)=>setTimeout(e,r)))}function o(r,e){const n=document.evaluate(r,e,null,XPathResult.ANY_TYPE,null),t=[];let o;for(;o=n.iterateNext(),o;)t.push(o);return t}n.d(e,{_v:()=>t,kH:()=>o})},540:(r,e,n)=>{n.a(r,(async(r,e)=>{try{var t=n(166),o=n(660);const i={serverPath:"//kroki.io/"};await(0,t._v)(3e3);const f=(0,t.kH)("//div[ contains( @class,'notion-code-block') and @data-block-id]",document.body);for(const l of f){if(0==(0,t.kH)(".//div[text()='Plain Text']",l).length)continue;const c=(0,t.kH)(".//div[contains(@class,'notion-code-block')]",l).at(0);if(c&&c.innerText.startsWith("//kroki")){var a;const v=c.innerText.split("\n"),s=v[0].replace("//kroki","").trim(),d=u(v.filter(((r,e)=>0!=e)).join("\n"),s,i),h=document.createElement("div",void 0);h.innerHTML=d,null===(a=c.parentElement)||void 0===a||a.appendChild(h)}}function u(r,e,n){r=r.trim(),console.log(`kroki render type: ${e}`),console.log(`kroki render content: \n ${r}`);const t=`${(null==n?void 0:n.serverPath)+e}/svg/`,a=(i=r,(new TextEncoder).encode(i));var i;const f=(0,o.T8)((0,o.iZ)(a,{level:9}),!0);return`<object type="image/svg+xml" data="${t+btoa(f).replace(/\+/g,"-").replace(/\//g,"_")}" />`}e()}catch(p){e(p)}}),1)},660:(r,e,n)=>{n.d(e,{T8:()=>R,iZ:()=>$});var t=Uint8Array,o=Uint16Array,a=Uint32Array,i=new t([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),f=new t([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),u=new t([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),l=function(r,e){for(var n=new o(31),t=0;t<31;++t)n[t]=e+=1<<r[t-1];var i=new a(n[30]);for(t=1;t<30;++t)for(var f=n[t];f<n[t+1];++f)i[f]=f-n[t]<<5|t;return[n,i]},c=l(i,2),v=c[0],s=c[1];v[28]=258,s[258]=28;for(var d=l(f,0),h=(d[0],d[1]),p=new o(32768),m=0;m<32768;++m){var w=(43690&m)>>>1|(21845&m)<<1;w=(61680&(w=(52428&w)>>>2|(13107&w)<<2))>>>4|(3855&w)<<4,p[m]=((65280&w)>>>8|(255&w)<<8)>>>1}var g=function(r,e,n){for(var t=r.length,a=0,i=new o(e);a<t;++a)r[a]&&++i[r[a]-1];var f,u=new o(e);for(a=0;a<e;++a)u[a]=u[a-1]+i[a-1]<<1;if(n){f=new o(1<<e);var l=15-e;for(a=0;a<t;++a)if(r[a])for(var c=a<<4|r[a],v=e-r[a],s=u[r[a]-1]++<<v,d=s|(1<<v)-1;s<=d;++s)f[p[s]>>>l]=c}else for(f=new o(t),a=0;a<t;++a)r[a]&&(f[a]=p[u[r[a]-1]++]>>>15-r[a]);return f},y=new t(288);for(m=0;m<144;++m)y[m]=8;for(m=144;m<256;++m)y[m]=9;for(m=256;m<280;++m)y[m]=7;for(m=280;m<288;++m)y[m]=8;var b=new t(32);for(m=0;m<32;++m)b[m]=5;var k=g(y,9,0),_=g(b,5,0),x=function(r){return(r+7)/8|0},E=function(r,e,n){(null==e||e<0)&&(e=0),(null==n||n>r.length)&&(n=r.length);var i=new(2==r.BYTES_PER_ELEMENT?o:4==r.BYTES_PER_ELEMENT?a:t)(n-e);return i.set(r.subarray(e,n)),i},T=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],M=function(r,e,n){var t=new Error(e||T[r]);if(t.code=r,Error.captureStackTrace&&Error.captureStackTrace(t,M),!n)throw t;return t},S=function(r,e,n){n<<=7&e;var t=e/8|0;r[t]|=n,r[t+1]|=n>>>8},P=function(r,e,n){n<<=7&e;var t=e/8|0;r[t]|=n,r[t+1]|=n>>>8,r[t+2]|=n>>>16},C=function(r,e){for(var n=[],a=0;a<r.length;++a)r[a]&&n.push({s:a,f:r[a]});var i=n.length,f=n.slice();if(!i)return[U,0];if(1==i){var u=new t(n[0].s+1);return u[n[0].s]=1,[u,1]}n.sort((function(r,e){return r.f-e.f})),n.push({s:-1,f:25001});var l=n[0],c=n[1],v=0,s=1,d=2;for(n[0]={s:-1,f:l.f+c.f,l,r:c};s!=i-1;)l=n[n[v].f<n[d].f?v++:d++],c=n[v!=s&&n[v].f<n[d].f?v++:d++],n[s++]={s:-1,f:l.f+c.f,l,r:c};var h=f[0].s;for(a=1;a<i;++a)f[a].s>h&&(h=f[a].s);var p=new o(h+1),m=j(n[s-1],p,0);if(m>e){a=0;var w=0,g=m-e,y=1<<g;for(f.sort((function(r,e){return p[e.s]-p[r.s]||r.f-e.f}));a<i;++a){var b=f[a].s;if(!(p[b]>e))break;w+=y-(1<<m-p[b]),p[b]=e}for(w>>>=g;w>0;){var k=f[a].s;p[k]<e?w-=1<<e-p[k]++-1:++a}for(;a>=0&&w;--a){var _=f[a].s;p[_]==e&&(--p[_],++w)}m=e}return[new t(p),m]},j=function(r,e,n){return-1==r.s?Math.max(j(r.l,e,n+1),j(r.r,e,n+1)):e[r.s]=n},H=function(r){for(var e=r.length;e&&!r[--e];);for(var n=new o(++e),t=0,a=r[0],i=1,f=function(r){n[t++]=r},u=1;u<=e;++u)if(r[u]==a&&u!=e)++i;else{if(!a&&i>2){for(;i>138;i-=138)f(32754);i>2&&(f(i>10?i-11<<5|28690:i-3<<5|12305),i=0)}else if(i>3){for(f(a),--i;i>6;i-=6)f(8304);i>2&&(f(i-3<<5|8208),i=0)}for(;i--;)f(a);i=1,a=r[u]}return[n.subarray(0,t),e]},q=function(r,e){for(var n=0,t=0;t<e.length;++t)n+=r[t]*e[t];return n},A=function(r,e,n){var t=n.length,o=x(e+2);r[o]=255&t,r[o+1]=t>>>8,r[o+2]=255^r[o],r[o+3]=255^r[o+1];for(var a=0;a<t;++a)r[o+a+4]=n[a];return 8*(o+4+t)},N=function(r,e,n,t,a,l,c,v,s,d,h){S(e,h++,n),++a[256];for(var p=C(a,15),m=p[0],w=p[1],x=C(l,15),E=x[0],T=x[1],M=H(m),j=M[0],N=M[1],O=H(E),U=O[0],Y=O[1],$=new o(19),L=0;L<j.length;++L)$[31&j[L]]++;for(L=0;L<U.length;++L)$[31&U[L]]++;for(var R=C($,7),B=R[0],D=R[1],F=19;F>4&&!B[u[F-1]];--F);var I,Z,z,W,X=d+5<<3,G=q(a,y)+q(l,b)+c,J=q(a,m)+q(l,E)+c+14+3*F+q($,B)+(2*$[16]+3*$[17]+7*$[18]);if(X<=G&&X<=J)return A(e,h,r.subarray(s,s+d));if(S(e,h,1+(J<G)),h+=2,J<G){I=g(m,w,0),Z=m,z=g(E,T,0),W=E;var K=g(B,D,0);for(S(e,h,N-257),S(e,h+5,Y-1),S(e,h+10,F-4),h+=14,L=0;L<F;++L)S(e,h+3*L,B[u[L]]);h+=3*F;for(var Q=[j,U],V=0;V<2;++V){var rr=Q[V];for(L=0;L<rr.length;++L){var er=31&rr[L];S(e,h,K[er]),h+=B[er],er>15&&(S(e,h,rr[L]>>>5&127),h+=rr[L]>>>12)}}}else I=k,Z=y,z=_,W=b;for(L=0;L<v;++L)if(t[L]>255){er=t[L]>>>18&31,P(e,h,I[er+257]),h+=Z[er+257],er>7&&(S(e,h,t[L]>>>23&31),h+=i[er]);var nr=31&t[L];P(e,h,z[nr]),h+=W[nr],nr>3&&(P(e,h,t[L]>>>5&8191),h+=f[nr])}else P(e,h,I[t[L]]),h+=Z[t[L]];return P(e,h,I[256]),h+Z[256]},O=new a([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),U=new t(0),Y=function(r,e,n,u,l){return function(r,e,n,u,l,c){var v=r.length,d=new t(u+v+5*(1+Math.ceil(v/7e3))+l),p=d.subarray(u,d.length-l),m=0;if(!e||v<8)for(var w=0;w<=v;w+=65535){var g=w+65535;g>=v&&(p[m>>3]=c),m=A(p,m+1,r.subarray(w,g))}else{for(var y=O[e-1],b=y>>>13,k=8191&y,_=(1<<n)-1,T=new o(32768),M=new o(_+1),S=Math.ceil(n/3),P=2*S,C=function(e){return(r[e]^r[e+1]<<S^r[e+2]<<P)&_},j=new a(25e3),H=new o(288),q=new o(32),Y=0,$=0,L=(w=0,0),R=0,B=0;w<v;++w){var D=C(w),F=32767&w,I=M[D];if(T[F]=I,M[D]=F,R<=w){var Z=v-w;if((Y>7e3||L>24576)&&Z>423){m=N(r,p,0,j,H,q,$,L,B,w-B,m),L=Y=$=0,B=w;for(var z=0;z<286;++z)H[z]=0;for(z=0;z<30;++z)q[z]=0}var W=2,X=0,G=k,J=F-I&32767;if(Z>2&&D==C(w-J))for(var K=Math.min(b,Z)-1,Q=Math.min(32767,w),V=Math.min(258,Z);J<=Q&&--G&&F!=I;){if(r[w+W]==r[w+W-J]){for(var rr=0;rr<V&&r[w+rr]==r[w+rr-J];++rr);if(rr>W){if(W=rr,X=J,rr>K)break;var er=Math.min(J,rr-2),nr=0;for(z=0;z<er;++z){var tr=w-J+z+32768&32767,or=tr-T[tr]+32768&32767;or>nr&&(nr=or,I=tr)}}}J+=(F=I)-(I=T[F])+32768&32767}if(X){j[L++]=268435456|s[W]<<18|h[X];var ar=31&s[W],ir=31&h[X];$+=i[ar]+f[ir],++H[257+ar],++q[ir],R=w+W,++Y}else j[L++]=r[w],++H[r[w]]}}m=N(r,p,c,j,H,q,$,L,B,w-B,m),!c&&7&m&&(m=A(p,m+1,U))}return E(d,0,u+x(m)+l)}(r,null==e.level?6:e.level,null==e.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(r.length)))):12+e.mem,n,u,!l)};function $(r,e){e||(e={});var n=function(){var r=1,e=0;return{p:function(n){for(var t=r,o=e,a=0|n.length,i=0;i!=a;){for(var f=Math.min(i+2655,a);i<f;++i)o+=t+=n[i];t=(65535&t)+15*(t>>16),o=(65535&o)+15*(o>>16)}r=t,e=o},d:function(){return(255&(r%=65521))<<24|r>>>8<<16|(255&(e%=65521))<<8|e>>>8}}}();n.p(r);var t=Y(r,e,2,4);return function(r,e){var n=e.level,t=0==n?0:n<6?1:9==n?3:2;r[0]=120,r[1]=t<<6|(t?32-2*t:1)}(t,e),function(r,e,n){for(;n;++e)r[e]=n,n>>>=8}(t,t.length-4,n.d()),t}var L="undefined"!=typeof TextDecoder&&new TextDecoder;try{L.decode(U,{stream:!0})}catch(r){}function R(r,e){if(e){for(var n="",t=0;t<r.length;t+=16384)n+=String.fromCharCode.apply(null,r.subarray(t,t+16384));return n}if(L)return L.decode(r);var o=function(r){for(var e="",n=0;;){var t=r[n++],o=(t>127)+(t>223)+(t>239);if(n+o>r.length)return[e,E(r,n-1)];o?3==o?(t=((15&t)<<18|(63&r[n++])<<12|(63&r[n++])<<6|63&r[n++])-65536,e+=String.fromCharCode(55296|t>>10,56320|1023&t)):e+=1&o?String.fromCharCode((31&t)<<6|63&r[n++]):String.fromCharCode((15&t)<<12|(63&r[n++])<<6|63&r[n++]):e+=String.fromCharCode(t)}}(r),a=o[0];return o[1].length&&M(8),a}"function"==typeof queueMicrotask?queueMicrotask:"function"==typeof setTimeout&&setTimeout}},a={};function i(r){var e=a[r];if(void 0!==e)return e.exports;var n=a[r]={exports:{}};return o[r](n,n.exports,i),n.exports}r="function"==typeof Symbol?Symbol("webpack queues"):"__webpack_queues__",e="function"==typeof Symbol?Symbol("webpack exports"):"__webpack_exports__",n="function"==typeof Symbol?Symbol("webpack error"):"__webpack_error__",t=r=>{r&&!r.d&&(r.d=1,r.forEach((r=>r.r--)),r.forEach((r=>r.r--?r.r++:r())))},i.a=(o,a,i)=>{var f;i&&((f=[]).d=1),f&&(f.moduleId=o.id);var u,l,c,v=new Set,s=o.exports,d=new Promise(((r,e)=>{c=e,l=r}));d[e]=s,d[r]=r=>(f&&r(f),v.forEach(r),d.catch((r=>{}))),d.moduleId=o.id,o.exports=d,a((o=>{var a;u=(o=>o.map((o=>{if(null!==o&&"object"==typeof o){if(o[r])return o;if(o.then){var a=[];a.d=0,o.then((r=>{i[e]=r,t(a)}),(r=>{i[n]=r,t(a)}));var i={};return i[r]=r=>r(a),i}}var f={};return f[r]=r=>{},f[e]=o,f})))(o);var i=()=>u.map((r=>{if(r[n])throw r[n];return r[e]})),l=new Promise((e=>{(a=()=>e(i)).r=0;var n=r=>r!==f&&!v.has(r)&&(v.add(r),r&&!r.d&&(a.r++,r.push(a)));u.map((e=>e[r](n)))}));return a.r?l:i()}),(r=>(r?c(d[n]=r):l(s),t(f)))),f&&(f.d=0)},i.d=(r,e)=>{for(var n in e)i.o(e,n)&&!i.o(r,n)&&Object.defineProperty(r,n,{enumerable:!0,get:e[n]})},i.o=(r,e)=>Object.prototype.hasOwnProperty.call(r,e),i(540)})();
