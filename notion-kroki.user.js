// ==UserScript==
// @name        notion-kroki
// @namespace   https://github.com/zuisong/notion-kroki
// @grant       none
// @version     1.1.4
// @match        *://www.notion.so/*
// @match        *://*.notion.site/*
// @match        *://*.super.site/*
// @supportURL  https://github.com/zuisong/notion-kroki/issues
// @run-at      document-idle
// @author      zuisong
// @description Render notion code block as graph by kroki
// ==/UserScript==

function pr(r,n){let e=document.evaluate(r,n,null,XPathResult.ANY_TYPE,null),t=[],i;for(;i=e.iterateNext(),i;)t.push(i);return t}function K(...r){localStorage.getItem("debug")&&console.log(...r)}function gr(r,n){let e;return function(...t){clearTimeout(e),e=setTimeout(()=>{clearTimeout(e),r(t)},n)}}var P=Uint8Array,x=Uint16Array,b=Uint32Array,fr=new P([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),sr=new P([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),yr=new P([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),xr=function(r,n){for(var e=new x(31),t=0;t<31;++t)e[t]=n+=1<<r[t-1];for(var i=new b(e[30]),t=1;t<30;++t)for(var o=e[t];o<e[t+1];++o)i[o]=o-e[t]<<5|t;return[e,i]},Tr=xr(fr,2),Cr=Tr[0],er=Tr[1];Cr[28]=258,er[258]=28;var Er=xr(sr,0),Wr=Er[0],mr=Er[1],ir=new x(32768);for(u=0;u<32768;++u)G=(u&43690)>>>1|(u&21845)<<1,G=(G&52428)>>>2|(G&13107)<<2,G=(G&61680)>>>4|(G&3855)<<4,ir[u]=((G&65280)>>>8|(G&255)<<8)>>>1;var G,u,J=function(r,n,e){for(var t=r.length,i=0,o=new x(n);i<t;++i)r[i]&&++o[r[i]-1];var f=new x(n);for(i=0;i<n;++i)f[i]=f[i-1]+o[i-1]<<1;var l;if(e){l=new x(1<<n);var h=15-n;for(i=0;i<t;++i)if(r[i])for(var v=i<<4|r[i],a=n-r[i],g=f[r[i]-1]++<<a,y=g|(1<<a)-1;g<=y;++g)l[ir[g]>>>h]=v}else for(l=new x(t),i=0;i<t;++i)r[i]&&(l[i]=ir[f[r[i]-1]++]>>>15-r[i]);return l},R=new P(288);for(u=0;u<144;++u)R[u]=8;var u;for(u=144;u<256;++u)R[u]=9;var u;for(u=256;u<280;++u)R[u]=7;var u;for(u=280;u<288;++u)R[u]=8;var u,V=new P(32);for(u=0;u<32;++u)V[u]=5;var u,Dr=J(R,9,0);var dr=J(V,5,0);var Mr=function(r){return(r+7)/8|0},Ir=function(r,n,e){(n==null||n<0)&&(n=0),(e==null||e>r.length)&&(e=r.length);var t=new(r.BYTES_PER_ELEMENT==2?x:r.BYTES_PER_ELEMENT==4?b:P)(e-n);return t.set(r.subarray(n,e)),t};var L=function(r,n,e){e<<=n&7;var t=n/8|0;r[t]|=e,r[t+1]|=e>>>8},W=function(r,n,e){e<<=n&7;var t=n/8|0;r[t]|=e,r[t+1]|=e>>>8,r[t+2]|=e>>>16},tr=function(r,n){for(var e=[],t=0;t<r.length;++t)r[t]&&e.push({s:t,f:r[t]});var i=e.length,o=e.slice();if(!i)return[ur,0];if(i==1){var f=new P(e[0].s+1);return f[e[0].s]=1,[f,1]}e.sort(function(I,U){return I.f-U.f}),e.push({s:-1,f:25001});var l=e[0],h=e[1],v=0,a=1,g=2;for(e[0]={s:-1,f:l.f+h.f,l,r:h};a!=i-1;)l=e[e[v].f<e[g].f?v++:g++],h=e[v!=a&&e[v].f<e[g].f?v++:g++],e[a++]={s:-1,f:l.f+h.f,l,r:h};for(var y=o[0].s,t=1;t<i;++t)o[t].s>y&&(y=o[t].s);var c=new x(y+1),z=ar(e[a-1],c,0);if(z>n){var t=0,p=0,M=z-n,S=1<<M;for(o.sort(function(U,w){return c[w.s]-c[U.s]||U.f-w.f});t<i;++t){var A=o[t].s;if(c[A]>n)p+=S-(1<<z-c[A]),c[A]=n;else break}for(p>>>=M;p>0;){var B=o[t].s;c[B]<n?p-=1<<n-c[B]++-1:++t}for(;t>=0&&p;--t){var N=o[t].s;c[N]==n&&(--c[N],++p)}z=n}return[new P(c),z]},ar=function(r,n,e){return r.s==-1?Math.max(ar(r.l,n,e+1),ar(r.r,n,e+1)):n[r.s]=e},wr=function(r){for(var n=r.length;n&&!r[--n];);for(var e=new x(++n),t=0,i=r[0],o=1,f=function(h){e[t++]=h},l=1;l<=n;++l)if(r[l]==i&&l!=n)++o;else{if(!i&&o>2){for(;o>138;o-=138)f(32754);o>2&&(f(o>10?o-11<<5|28690:o-3<<5|12305),o=0)}else if(o>3){for(f(i),--o;o>6;o-=6)f(8304);o>2&&(f(o-3<<5|8208),o=0)}for(;o--;)f(i);o=1,i=r[l]}return[e.subarray(0,t),n]},X=function(r,n){for(var e=0,t=0;t<n.length;++t)e+=r[t]*n[t];return e},or=function(r,n,e){var t=e.length,i=Mr(n+2);r[i]=t&255,r[i+1]=t>>>8,r[i+2]=r[i]^255,r[i+3]=r[i+1]^255;for(var o=0;o<t;++o)r[i+o+4]=e[o];return(i+4+t)*8},zr=function(r,n,e,t,i,o,f,l,h,v,a){L(n,a++,e),++i[256];for(var g=tr(i,15),y=g[0],c=g[1],z=tr(o,15),p=z[0],M=z[1],S=wr(y),A=S[0],B=S[1],N=wr(p),I=N[0],U=N[1],w=new x(19),s=0;s<A.length;++s)w[A[s]&31]++;for(var s=0;s<I.length;++s)w[I[s]&31]++;for(var H=tr(w,7),k=H[0],Q=H[1],T=19;T>4&&!k[yr[T-1]];--T);var Y=v+5<<3,C=X(i,R)+X(o,V)+f,D=X(i,y)+X(o,p)+f+14+3*T+X(w,k)+(2*w[16]+3*w[17]+7*w[18]);if(Y<=C&&Y<=D)return or(n,a,r.subarray(h,h+v));var Z,m,d,$;if(L(n,a,1+(D<C)),a+=2,D<C){Z=J(y,c,0),m=y,d=J(p,M,0),$=p;var _=J(k,Q,0);L(n,a,B-257),L(n,a+5,U-1),L(n,a+10,T-4),a+=14;for(var s=0;s<T;++s)L(n,a+3*s,k[yr[s]]);a+=3*T;for(var F=[A,I],j=0;j<2;++j)for(var q=F[j],s=0;s<q.length;++s){var O=q[s]&31;L(n,a,_[O]),a+=k[O],O>15&&(L(n,a,q[s]>>>5&127),a+=q[s]>>>12)}}else Z=Dr,m=R,d=dr,$=V;for(var s=0;s<l;++s)if(t[s]>255){var O=t[s]>>>18&31;W(n,a,Z[O+257]),a+=m[O+257],O>7&&(L(n,a,t[s]>>>23&31),a+=fr[O]);var E=t[s]&31;W(n,a,d[E]),a+=$[E],E>3&&(W(n,a,t[s]>>>5&8191),a+=sr[E])}else W(n,a,Z[t[s]]),a+=m[t[s]];return W(n,a,Z[256]),a+m[256]},Zr=new b([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),ur=new P(0),Fr=function(r,n,e,t,i,o){var f=r.length,l=new P(t+f+5*(1+Math.ceil(f/7e3))+i),h=l.subarray(t,l.length-i),v=0;if(!n||f<8)for(var a=0;a<=f;a+=65535){var g=a+65535;g>=f&&(h[v>>3]=o),v=or(h,v+1,r.subarray(a,g))}else{for(var y=Zr[n-1],c=y>>>13,z=y&8191,p=(1<<e)-1,M=new x(32768),S=new x(p+1),A=Math.ceil(e/3),B=2*A,N=function(nr){return(r[nr]^r[nr+1]<<A^r[nr+2]<<B)&p},I=new b(25e3),U=new x(288),w=new x(32),s=0,H=0,a=0,k=0,Q=0,T=0;a<f;++a){var Y=N(a),C=a&32767,D=S[Y];if(M[C]=D,S[Y]=C,Q<=a){var Z=f-a;if((s>7e3||k>24576)&&Z>423){v=zr(r,h,0,I,U,w,H,k,T,a-T,v),k=s=H=0,T=a;for(var m=0;m<286;++m)U[m]=0;for(var m=0;m<30;++m)w[m]=0}var d=2,$=0,_=z,F=C-D&32767;if(Z>2&&Y==N(a-F))for(var j=Math.min(c,Z)-1,q=Math.min(32767,a),O=Math.min(258,Z);F<=q&&--_&&C!=D;){if(r[a+d]==r[a+d-F]){for(var E=0;E<O&&r[a+E]==r[a+E-F];++E);if(E>d){if(d=E,$=F,E>j)break;for(var kr=Math.min(F,E-2),lr=0,m=0;m<kr;++m){var rr=a-F+m+32768&32767,Sr=M[rr],vr=rr-Sr+32768&32767;vr>lr&&(lr=vr,D=rr)}}}C=D,D=M[C],F+=C-D+32768&32767}if($){I[k++]=268435456|er[d]<<18|mr[$];var hr=er[d]&31,cr=mr[$]&31;H+=fr[hr]+sr[cr],++U[257+hr],++w[cr],Q=a+d,++s}else I[k++]=r[a],++U[r[a]]}}v=zr(r,h,o,I,U,w,H,k,T,a-T,v),!o&&v&7&&(v=or(h,v+1,ur))}return Ir(l,0,t+Mr(v)+i)};var Or=function(){var r=1,n=0;return{p:function(e){for(var t=r,i=n,o=e.length|0,f=0;f!=o;){for(var l=Math.min(f+2655,o);f<l;++f)i+=t+=e[f];t=(t&65535)+15*(t>>16),i=(i&65535)+15*(i>>16)}r=t,n=i},d:function(){return r%=65521,n%=65521,(r&255)<<24|r>>>8<<16|(n&255)<<8|n>>>8}}},Pr=function(r,n,e,t,i){return Fr(r,n.level==null?6:n.level,n.mem==null?Math.ceil(Math.max(8,Math.min(13,Math.log(r.length)))*1.5):12+n.mem,e,t,!i)};var Gr=function(r,n,e){for(;e;++n)r[n]=e,e>>>=8};var Lr=function(r,n){var e=n.level,t=e==0?0:e<6?1:e==9?3:2;r[0]=120,r[1]=t<<6|(t?32-2*t:1)};function Ar(r,n){n||(n={});var e=Or();e.p(r);var t=Pr(r,n,2,4);return Lr(t,n),Gr(t,t.length-4,e.d()),t}var Nr=typeof TextDecoder<"u"&&new TextDecoder,$r=0;try{Nr.decode(ur,{stream:!0}),$r=1}catch(r){}var Hr={serverPath:"//kroki.io/"};function Rr(r){return btoa(r)}function Ur(r=null){var e,t,i,o,f,l,h,v;let n=pr("//*[starts-with(text(),'//kroki ')]",r!=null?r:document.body);for(let a of n)if(!!a&&(e=a.textContent)!=null&&e.startsWith("//kroki")){let g=a.textContent.split(`
`),y=g[0].replace("//kroki","").trim();if(!(y!=null&&y.trim()))continue;let c=g.filter((S,A)=>A!=0).join(`
`);if(!(c!=null&&c.trim()))continue;let z=Yr(c,y,Hr),p=document.createElement("div",void 0);p.style.cssText="display: flex; flex-direction: row; place-content: center;",p.setAttribute("notion-kroki","true"),p.innerHTML=`<object type="image/svg+xml" style="max-width: 100%;" data="${z}" />`;let M=(i=(t=a.parentElement)==null?void 0:t.parentElement)==null?void 0:i.querySelector("div[notion-kroki]");if(M){let S=(o=M.firstElementChild)==null?void 0:o.getAttribute("data");if(K(`preSvgUrl:${S}`),K(`svgUrl:${z}`),S==z)continue;(l=(f=a.parentElement)==null?void 0:f.parentElement)==null||l.removeChild(M)}(v=(h=a.parentElement)==null?void 0:h.parentElement)==null||v.appendChild(p)}}function Br(r){return new TextEncoder().encode(r)}function Yr(r,n,e){r=r.trim(),K(`kroki render type: ${n}`),K(`kroki render content: 
 ${r}`);let t=`${(e==null?void 0:e.serverPath)+n}/svg/`,i=Br(r),o=Kr(Ar(i,{level:9})),f=Rr(o).replace(/\+/g,"-").replace(/\//g,"_");return t+f}Ur();new MutationObserver(qr).observe(document,{childList:!0,subtree:!0});function qr(r,n){K("mutations",r),r.forEach(e=>{gr(()=>Ur(),1e3)(e.target)})}function Kr(r){let n="";for(let e=0;e<r.length;e+=16384)n+=String.fromCharCode(...r.subarray(e,e+16384));return n}

