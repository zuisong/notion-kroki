// ==UserScript==
// @name        notion-kroki
// @namespace   https://github.com/zuisong/notion-kroki
// @grant       none
// @version     1.1.4
// @match        *://www.notion.so/*
// @match        *://*.notion.site/*
// @match        *://*.super.site/*
// @supportURL  https://github.com/zuisong/notion-kroki/issues
// @run-at      document-idle
// @author      zuisong
// @description Render notion code block as graph by kroki
// ==/UserScript==

function pr(r,n){let e=document.evaluate(r,n,null,XPathResult.ANY_TYPE,null),t=[],i;for(;i=e.iterateNext(),i;)t.push(i);return t}function j(r){localStorage.getItem("debug")&&console.log(r)}function gr(r,n){let e;return function(...t){clearTimeout(e),e=setTimeout(()=>r(t),n)}}var P=Uint8Array,z=Uint16Array,b=Uint32Array,fr=new P([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),sr=new P([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),yr=new P([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),zr=function(r,n){for(var e=new z(31),t=0;t<31;++t)e[t]=n+=1<<r[t-1];for(var i=new b(e[30]),t=1;t<30;++t)for(var o=e[t];o<e[t+1];++o)i[o]=o-e[t]<<5|t;return[e,i]},Tr=zr(fr,2),Sr=Tr[0],er=Tr[1];Sr[28]=258,er[258]=28;var Ar=zr(sr,0),Wr=Ar[0],mr=Ar[1],ir=new z(32768);for(u=0;u<32768;++u)O=(u&43690)>>>1|(u&21845)<<1,O=(O&52428)>>>2|(O&13107)<<2,O=(O&61680)>>>4|(O&3855)<<4,ir[u]=((O&65280)>>>8|(O&255)<<8)>>>1;var O,u,J=function(r,n,e){for(var t=r.length,i=0,o=new z(n);i<t;++i)r[i]&&++o[r[i]-1];var f=new z(n);for(i=0;i<n;++i)f[i]=f[i-1]+o[i-1]<<1;var l;if(e){l=new z(1<<n);var h=15-n;for(i=0;i<t;++i)if(r[i])for(var v=i<<4|r[i],a=n-r[i],g=f[r[i]-1]++<<a,y=g|(1<<a)-1;g<=y;++g)l[ir[g]>>>h]=v}else for(l=new z(t),i=0;i<t;++i)r[i]&&(l[i]=ir[f[r[i]-1]++]>>>15-r[i]);return l},H=new P(288);for(u=0;u<144;++u)H[u]=8;var u;for(u=144;u<256;++u)H[u]=9;var u;for(u=256;u<280;++u)H[u]=7;var u;for(u=280;u<288;++u)H[u]=8;var u,V=new P(32);for(u=0;u<32;++u)V[u]=5;var u,Dr=J(H,9,0);var dr=J(V,5,0);var Er=function(r){return(r+7)/8|0},Fr=function(r,n,e){(n==null||n<0)&&(n=0),(e==null||e>r.length)&&(e=r.length);var t=new(r.BYTES_PER_ELEMENT==2?z:r.BYTES_PER_ELEMENT==4?b:P)(e-n);return t.set(r.subarray(n,e)),t};var G=function(r,n,e){e<<=n&7;var t=n/8|0;r[t]|=e,r[t+1]|=e>>>8},W=function(r,n,e){e<<=n&7;var t=n/8|0;r[t]|=e,r[t+1]|=e>>>8,r[t+2]|=e>>>16},tr=function(r,n){for(var e=[],t=0;t<r.length;++t)r[t]&&e.push({s:t,f:r[t]});var i=e.length,o=e.slice();if(!i)return[ur,0];if(i==1){var f=new P(e[0].s+1);return f[e[0].s]=1,[f,1]}e.sort(function(F,U){return F.f-U.f}),e.push({s:-1,f:25001});var l=e[0],h=e[1],v=0,a=1,g=2;for(e[0]={s:-1,f:l.f+h.f,l,r:h};a!=i-1;)l=e[e[v].f<e[g].f?v++:g++],h=e[v!=a&&e[v].f<e[g].f?v++:g++],e[a++]={s:-1,f:l.f+h.f,l,r:h};for(var y=o[0].s,t=1;t<i;++t)o[t].s>y&&(y=o[t].s);var c=new z(y+1),x=ar(e[a-1],c,0);if(x>n){var t=0,p=0,E=x-n,C=1<<E;for(o.sort(function(U,w){return c[w.s]-c[U.s]||U.f-w.f});t<i;++t){var M=o[t].s;if(c[M]>n)p+=C-(1<<x-c[M]),c[M]=n;else break}for(p>>>=E;p>0;){var R=o[t].s;c[R]<n?p-=1<<n-c[R]++-1:++t}for(;t>=0&&p;--t){var L=o[t].s;c[L]==n&&(--c[L],++p)}x=n}return[new P(c),x]},ar=function(r,n,e){return r.s==-1?Math.max(ar(r.l,n,e+1),ar(r.r,n,e+1)):n[r.s]=e},wr=function(r){for(var n=r.length;n&&!r[--n];);for(var e=new z(++n),t=0,i=r[0],o=1,f=function(h){e[t++]=h},l=1;l<=n;++l)if(r[l]==i&&l!=n)++o;else{if(!i&&o>2){for(;o>138;o-=138)f(32754);o>2&&(f(o>10?o-11<<5|28690:o-3<<5|12305),o=0)}else if(o>3){for(f(i),--o;o>6;o-=6)f(8304);o>2&&(f(o-3<<5|8208),o=0)}for(;o--;)f(i);o=1,i=r[l]}return[e.subarray(0,t),n]},X=function(r,n){for(var e=0,t=0;t<n.length;++t)e+=r[t]*n[t];return e},or=function(r,n,e){var t=e.length,i=Er(n+2);r[i]=t&255,r[i+1]=t>>>8,r[i+2]=r[i]^255,r[i+3]=r[i+1]^255;for(var o=0;o<t;++o)r[i+o+4]=e[o];return(i+4+t)*8},xr=function(r,n,e,t,i,o,f,l,h,v,a){G(n,a++,e),++i[256];for(var g=tr(i,15),y=g[0],c=g[1],x=tr(o,15),p=x[0],E=x[1],C=wr(y),M=C[0],R=C[1],L=wr(p),F=L[0],U=L[1],w=new z(19),s=0;s<M.length;++s)w[M[s]&31]++;for(var s=0;s<F.length;++s)w[F[s]&31]++;for(var $=tr(w,7),k=$[0],Q=$[1],T=19;T>4&&!k[yr[T-1]];--T);var Y=v+5<<3,S=X(i,H)+X(o,V)+f,D=X(i,y)+X(o,p)+f+14+3*T+X(w,k)+(2*w[16]+3*w[17]+7*w[18]);if(Y<=S&&Y<=D)return or(n,a,r.subarray(h,h+v));var I,m,d,N;if(G(n,a,1+(D<S)),a+=2,D<S){I=J(y,c,0),m=y,d=J(p,E,0),N=p;var _=J(k,Q,0);G(n,a,R-257),G(n,a+5,U-1),G(n,a+10,T-4),a+=14;for(var s=0;s<T;++s)G(n,a+3*s,k[yr[s]]);a+=3*T;for(var B=[M,F],K=0;K<2;++K)for(var q=B[K],s=0;s<q.length;++s){var Z=q[s]&31;G(n,a,_[Z]),a+=k[Z],Z>15&&(G(n,a,q[s]>>>5&127),a+=q[s]>>>12)}}else I=Dr,m=H,d=dr,N=V;for(var s=0;s<l;++s)if(t[s]>255){var Z=t[s]>>>18&31;W(n,a,I[Z+257]),a+=m[Z+257],Z>7&&(G(n,a,t[s]>>>23&31),a+=fr[Z]);var A=t[s]&31;W(n,a,d[A]),a+=N[A],A>3&&(W(n,a,t[s]>>>5&8191),a+=sr[A])}else W(n,a,I[t[s]]),a+=m[t[s]];return W(n,a,I[256]),a+m[256]},Ir=new b([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),ur=new P(0),Br=function(r,n,e,t,i,o){var f=r.length,l=new P(t+f+5*(1+Math.ceil(f/7e3))+i),h=l.subarray(t,l.length-i),v=0;if(!n||f<8)for(var a=0;a<=f;a+=65535){var g=a+65535;g>=f&&(h[v>>3]=o),v=or(h,v+1,r.subarray(a,g))}else{for(var y=Ir[n-1],c=y>>>13,x=y&8191,p=(1<<e)-1,E=new z(32768),C=new z(p+1),M=Math.ceil(e/3),R=2*M,L=function(nr){return(r[nr]^r[nr+1]<<M^r[nr+2]<<R)&p},F=new b(25e3),U=new z(288),w=new z(32),s=0,$=0,a=0,k=0,Q=0,T=0;a<f;++a){var Y=L(a),S=a&32767,D=C[Y];if(E[S]=D,C[Y]=S,Q<=a){var I=f-a;if((s>7e3||k>24576)&&I>423){v=xr(r,h,0,F,U,w,$,k,T,a-T,v),k=s=$=0,T=a;for(var m=0;m<286;++m)U[m]=0;for(var m=0;m<30;++m)w[m]=0}var d=2,N=0,_=x,B=S-D&32767;if(I>2&&Y==L(a-B))for(var K=Math.min(c,I)-1,q=Math.min(32767,a),Z=Math.min(258,I);B<=q&&--_&&S!=D;){if(r[a+d]==r[a+d-B]){for(var A=0;A<Z&&r[a+A]==r[a+A-B];++A);if(A>d){if(d=A,N=B,A>K)break;for(var kr=Math.min(B,A-2),lr=0,m=0;m<kr;++m){var rr=a-B+m+32768&32767,Cr=E[rr],vr=rr-Cr+32768&32767;vr>lr&&(lr=vr,D=rr)}}}S=D,D=E[S],B+=S-D+32768&32767}if(N){F[k++]=268435456|er[d]<<18|mr[N];var hr=er[d]&31,cr=mr[N]&31;$+=fr[hr]+sr[cr],++U[257+hr],++w[cr],Q=a+d,++s}else F[k++]=r[a],++U[r[a]]}}v=xr(r,h,o,F,U,w,$,k,T,a-T,v),!o&&v&7&&(v=or(h,v+1,ur))}return Fr(l,0,t+Er(v)+i)};var Zr=function(){var r=1,n=0;return{p:function(e){for(var t=r,i=n,o=e.length|0,f=0;f!=o;){for(var l=Math.min(f+2655,o);f<l;++f)i+=t+=e[f];t=(t&65535)+15*(t>>16),i=(i&65535)+15*(i>>16)}r=t,n=i},d:function(){return r%=65521,n%=65521,(r&255)<<24|r>>>8<<16|(n&255)<<8|n>>>8}}},Pr=function(r,n,e,t,i){return Br(r,n.level==null?6:n.level,n.mem==null?Math.ceil(Math.max(8,Math.min(13,Math.log(r.length)))*1.5):12+n.mem,e,t,!i)};var Or=function(r,n,e){for(;e;++n)r[n]=e,e>>>=8};var Gr=function(r,n){var e=n.level,t=e==0?0:e<6?1:e==9?3:2;r[0]=120,r[1]=t<<6|(t?32-2*t:1)};function Mr(r,n){n||(n={});var e=Zr();e.p(r);var t=Pr(r,n,2,4);return Gr(t,n),Or(t,t.length-4,e.d()),t}var Lr=typeof TextDecoder<"u"&&new TextDecoder,Nr=0;try{Lr.decode(ur,{stream:!0}),Nr=1}catch(r){}var $r={serverPath:"//kroki.io/"};function Hr(r){return btoa(r)}function Ur(r=null){var e,t,i,o,f,l,h,v;let n=pr("//*[starts-with(text(),'//kroki ')]",r!=null?r:document.body);for(let a of n)if(!!a&&(e=a.textContent)!=null&&e.startsWith("//kroki")){let g=a.textContent.split(`
`),y=g[0].replace("//kroki","").trim();if(!(y!=null&&y.trim()))continue;let c=g.filter((C,M)=>M!=0).join(`
`);if(!(c!=null&&c.trim()))continue;let x=Yr(c,y,$r),p=document.createElement("div",void 0);p.style.cssText="display: flex; flex-direction: row; place-content: center;",p.setAttribute("notion-kroki","true"),p.innerHTML=`<object type="image/svg+xml" style="max-width: 100%;" data="${x}" />`;let E=(i=(t=a.parentElement)==null?void 0:t.parentElement)==null?void 0:i.querySelector("div[notion-kroki]");if(E){let C=(o=E.firstElementChild)==null?void 0:o.getAttribute("data");if(j(`preSvgUrl:${C}`),j(`svgUrl:${x}`),C==x)continue;(l=(f=a.parentElement)==null?void 0:f.parentElement)==null||l.removeChild(E)}(v=(h=a.parentElement)==null?void 0:h.parentElement)==null||v.appendChild(p)}}function Rr(r){return new TextEncoder().encode(r)}function Yr(r,n,e){r=r.trim(),j(`kroki render type: ${n}`),j(`kroki render content: 
 ${r}`);let t=`${(e==null?void 0:e.serverPath)+n}/svg/`,i=Rr(r),o=jr(Mr(i,{level:9})),f=Hr(o).replace(/\+/g,"-").replace(/\//g,"_");return t+f}Ur();new MutationObserver(qr).observe(document,{childList:!0,subtree:!0});function qr(r,n){j(r),r.forEach(e=>{gr(()=>Ur(),1e3)(e.target)})}function jr(r){let n="";for(let e=0;e<r.length;e+=16384)n+=String.fromCharCode(...r.subarray(e,e+16384));return n}

