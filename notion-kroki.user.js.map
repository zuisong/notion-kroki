{"version":3,"file":"notion-kroki.user.js","sources":["src/common/utils.ts","src/main.ts","src/index.ts"],"sourcesContent":["export type Any = Parameters<typeof console.log>[0];\n\nexport function debounce<\n  T extends (...args: Any[]) => void,\n  P extends Parameters<T>,\n>(func: T, wait: number): (...args: P) => void {\n  let timeoutId: ReturnType<typeof setTimeout> | undefined;\n  return (...args: P) => {\n    clearTimeout(timeoutId);\n    timeoutId = setTimeout(() => {\n      timeoutId = undefined;\n      func(...args);\n    }, wait);\n  };\n}\n\nexport function _debug(...data: Any[]): void {\n  if (isDebugMode()) {\n    console.log(...data);\n  }\n}\n\nexport function isDebugMode(): boolean {\n  return !!localStorage.getItem(\"debug\");\n}\n","import type { KrokiOption } from \"./@types/types.ts\";\nimport { _debug, debounce } from \"./common/utils.ts\";\nconst defaultConfig: KrokiOption = {\n  serverPath: \"https://kroki.io/\",\n};\n\nexport function main(element: HTMLElement | null = null) {\n  const blocks: HTMLElement[] = Array.from(\n    (element || document.body).querySelectorAll(\"*\"),\n  ).filter((it) => it.innerHTML.trim().startsWith(\"//kroki \")) as HTMLElement[];\n  for (const codeDiv of blocks) {\n    const lines = codeDiv.textContent?.split(\"\\n\") ?? [];\n    if (lines.length === 0) continue\n    const type = lines[0].replace(\"//kroki\", \"\").trim();\n    if (!type.trim()) continue;\n    const data = lines.filter((_value, index) => index !== 0).join(\"\\n\");\n    if (!data.trim()) continue;\n    const svgUrl = plant(data, type, defaultConfig);\n    const div = document.createElement(\"div\");\n    div.setAttribute(\n      \"style\",\n      \"display: flex; flex-direction: row; place-content: center;\",\n    );\n    div.setAttribute(\"notion-kroki\", \"true\");\n    div.innerHTML =\n      `<object type=\"image/svg+xml\" style=\"max-width: 100%;\" data=\"${svgUrl}\" />`;\n\n    const parentElement = codeDiv.parentElement?.parentElement;\n    if (!parentElement) {\n      continue;\n    }\n    const preCreatedNode = parentElement.querySelector(\"div[notion-kroki]\");\n    if (preCreatedNode) {\n      const preSvgUrl = preCreatedNode.firstElementChild?.getAttribute(\"data\");\n      _debug(`preSvgUrl:${preSvgUrl}`);\n      _debug(`svgUrl:${svgUrl}`);\n      if (preSvgUrl === svgUrl) {\n        continue;\n      }\n      parentElement.removeChild(preCreatedNode);\n    }\n\n    parentElement.appendChild(div);\n  }\n}\n\nfunction textEncode(str: string) {\n  return new TextEncoder().encode(str);\n}\n\nfunction plant(content: string, type: string, config: KrokiOption) {\n  _debug(`kroki render type: ${type}`);\n  _debug(`kroki render content:\\n${content}`);\n\n  const urlPrefix = `${config.serverPath + type}/svg/`;\n  const data: Uint8Array = textEncode(content);\n  const compressed: string = strFromU8(fflate.zlibSync(data, { level: 9 }));\n  const result: string = btoa(compressed)\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\");\n  const svgUrl: string = urlPrefix + result;\n\n  return svgUrl;\n}\n\nexport function init_listener() {\n  if (typeof MutationObserver !== typeof undefined) {\n    new MutationObserver(check).observe(document, {\n      childList: true,\n      subtree: true,\n    });\n  }\n}\n\nconst render = debounce(main, 100);\n\nfunction check(mutations: MutationRecord[], _observer: MutationObserver) {\n  // _debug(\"mutations\", mutations);\n  render();\n}\n\nfunction strFromU8(dat: Uint8Array) {\n  let r = \"\";\n  const s = 2 ** 15;\n  for (let i = 0; i < dat.length; i += s) {\n    r += String.fromCharCode(...dat.subarray(i, i + s));\n  }\n  return r;\n}\n","import { init_listener, main } from \"./main.ts\";\nmain();\ninit_listener();\n"],"names":["debounce","func","wait","timeoutId","args","clearTimeout","setTimeout","undefined","_debug","data","isDebugMode","console","log","localStorage","getItem","defaultConfig","serverPath","main","element","blocks","Array","from","document","body","querySelectorAll","filter","it","innerHTML","trim","startsWith","codeDiv","lines","textContent","split","length","type","replace","_value","index","join","svgUrl","plant","div","createElement","setAttribute","parentElement","preCreatedNode","querySelector","preSvgUrl","firstElementChild","getAttribute","removeChild","appendChild","textEncode","str","TextEncoder","encode","content","config","urlPrefix","compressed","strFromU8","fflate","zlibSync","level","result","btoa","init_listener","MutationObserver","check","observe","childList","subtree","render","mutations","_observer","dat","r","s","i","String","fromCharCode","subarray"],"mappings":"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"}